<!DOCTYPE html>
<html lang="zh-Hant">
    <head>
        <meta charset="utf-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1"
        />
        <title>午餐吃什麼</title>
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor"
            crossorigin="anonymous"
        />
        <meta name="robots" content="index, follow" />
        <base target="_self" />
        <meta name="description" content="" />
        <meta name="author" content="Rocky Wu" />
        <link rel="stylesheet" href="./style.css" />
    </head>
    <body style="margin: 0">
        <div style="display: flex">
            <div id="map" style="width: 50%; height: 100vh"></div>
            <div style="padding: 16px">
                <h3>午餐吃什麼</h3>
                <input id="search-input" class="form-control" />
                <button class="btn btn-primary mt-2" id="add">
                    加入我的最愛
                </button>

                <h4 class="mt-4">我的最愛</h4>
                <ul
                    class="list-group list-group-flush list-group-numbered"
                    id="restaurant-list"
                ></ul>
                <!-- Trigger/Open The Modal -->
                <button id="myBtn">抽籤</button>

                <!-- The Modal -->
                <div id="myModal" class="modal">
                    <!-- Modal content -->
                    <div class="modal-content">
                        <span class="close">&times;</span>
                        <input
                            type="button"
                            value="spin"
                            style="float: left"
                            id="spin"
                        />
                        <canvas
                            id="canvas"
                            width="500"
                            height="500"
                        ></canvas>
                    </div>
                </div>
            </div>
        </div>

        <script>
            let map;
            let currentPosition;
            let selectedRestaurant;
            let marker;
            let directionsService;
            let directionsRenderer;
            let infoWindow;

            // Get the modal
            var modal = document.getElementById("myModal");

            // Get the button that opens the modal
            var btn = document.getElementById("myBtn");

            // Get the <span> element that closes the modal
            var span = document.getElementsByClassName("close")[0];

            // When the user clicks on the button, open the modal
            btn.onclick = function () {
                modal.style.display = "block";
            };

            // When the user clicks on <span> (x), close the modal
            span.onclick = function () {
                modal.style.display = "none";
            };

            // When the user clicks anywhere outside of the modal, close it
            window.onclick = function (event) {
                if (event.target == modal) {
                    modal.style.display = "none";
                }
            };

            //map
            function initMap() {
                map = new google.maps.Map(document.getElementById("map"), {
                    center: { lat: 23.553118, lng: 121.0211024 },
                    zoom: 7,
                });

                navigator.geolocation.getCurrentPosition(function (
                    position
                ) {
                    currentPosition = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                    };

                    map.setCenter(currentPosition);
                    map.setZoom(16);

                    const autocomplete =
                        new google.maps.places.Autocomplete(
                            document.getElementById("search-input"),
                            {
                                types: ["restaurant"],
                                bounds: {
                                    east: currentPosition.lng + 0.001,
                                    west: currentPosition.lng - 0.001,
                                    south: currentPosition.lat - 0.001,
                                    north: currentPosition.lat + 0.001,
                                },
                                strictBounds: false,
                            }
                        );

                    autocomplete.addListener("place_changed", function () {
                        const place = autocomplete.getPlace();

                        selectedRestaurant = {
                            location: place.geometry.location,
                            placeId: place.place_id,
                            name: place.name,
                            address: place.formatted_address,
                            phoneNumber: place.formatted_phone_number,
                            rating: place.rating,
                        };

                        map.setCenter(selectedRestaurant.location);

                        if (!marker) {
                            marker = new google.maps.Marker({
                                map: map,
                            });
                        }

                        marker.setPosition(selectedRestaurant.location);

                        if (!directionsService) {
                            directionsService =
                                new google.maps.DirectionsService();
                        }

                        if (!directionsRenderer) {
                            directionsRenderer =
                                new google.maps.DirectionsRenderer({
                                    map: map,
                                });
                        }

                        directionsRenderer.set("directions", null);

                        directionsService.route(
                            {
                                origin: new google.maps.LatLng(
                                    currentPosition.lat,
                                    currentPosition.lng
                                ),
                                destination: {
                                    placeId: selectedRestaurant.placeId,
                                },
                                travelMode: "WALKING",
                            },
                            function (response, status) {
                                if (status === "OK") {
                                    directionsRenderer.setDirections(
                                        response
                                    );

                                    if (!infoWindow) {
                                        infoWindow =
                                            new google.maps.InfoWindow();
                                    }

                                    infoWindow.setContent(
                                        `
                                        <h3>${selectedRestaurant.name}<h3>
                                        <div>地址:${selectedRestaurant.address}</div>
                                        <div>電話:${selectedRestaurant.phoneNumber}</div>
                                        <div>評分:${selectedRestaurant.rating}</div>
                                        <div>步行時間:${response.routes[0].legs[0].duration.text}</div>
                                        `
                                    );
                                    infoWindow.open(map, marker);
                                }
                            }
                        );
                    });
                });
            }

            document
                .getElementById("add")
                .addEventListener("click", function () {
                    document.getElementById(
                        "restaurant-list"
                    ).innerHTML += `
                    <li class="list-group-item">
                        ${selectedRestaurant.name}
                        <button class="btn-close float-end remove"></button>
                    </li>
                    `;
                    //新增到我的最愛
                    const restaurantList =
                        JSON.parse(
                            localStorage.getItem("restaurantList")
                        ) || [];
                    restaurantList.push(selectedRestaurant);
                    localStorage.setItem(
                        "restaurantList",
                        JSON.stringify(restaurantList)
                    );
                });

            document
                .getElementById("restaurant-list")
                .addEventListener("click", function (e) {
                    if (e.target.classList.contains("remove")) {
                        e.target.parentNode.remove();
                        const restaurantName =
                            e.target.parentNode.innerText.trim();

                        //和我的最愛相同
                        const restaurantList =
                            JSON.parse(
                                localStorage.getItem("restaurantList")
                            ) || [];
                        const newRestaurantList = restaurantList.filter(
                            function (restaurant) {
                                if (restaurant.name === restaurantName)
                                    return false;
                                return true;
                            }
                        );
                        localStorage.setItem(
                            "restaurantList",
                            JSON.stringify(newRestaurantList)
                        );
                    }
                });

            //roulette
            var options = [];
            var startAngle = 0;
            var arc = Math.PI / (options.length / 2);
            var spinTimeout = null;

            var spinArcStart = 10;
            var spinTime = 0;
            var spinTimeTotal = 0;

            var ctx;

            document
                .getElementById("spin")
                .addEventListener("click", spin);

            function byte2Hex(n) {
                var nybHexString = "0123456789ABCDEF";
                return (
                    String(nybHexString.substr((n >> 4) & 0x0f, 1)) +
                    nybHexString.substr(n & 0x0f, 1)
                );
            }

            function RGB2Color(r, g, b) {
                return "#" + byte2Hex(r) + byte2Hex(g) + byte2Hex(b);
            }

            function getColor(item, maxitem) {
                var phase = 0;
                var center = 128;
                var width = 127;
                var frequency = (Math.PI * 2) / maxitem;

                red =
                    Math.sin(frequency * item + 2 + phase) * width +
                    center;
                green =
                    Math.sin(frequency * item + 0 + phase) * width +
                    center;
                blue =
                    Math.sin(frequency * item + 4 + phase) * width +
                    center;

                return RGB2Color(red, green, blue);
            }

            function drawRouletteWheel() {
                var canvas = document.getElementById("canvas");
                if (canvas.getContext) {
                    var outsideRadius = 200;
                    var textRadius = 160;
                    var insideRadius = 125;

                    ctx = canvas.getContext("2d");
                    ctx.clearRect(0, 0, 500, 500);

                    ctx.strokeStyle = "black";
                    ctx.lineWidth = 2;

                    ctx.font = "bold 12px Helvetica, Arial";

                    for (var i = 0; i < options.length; i++) {
                        var angle = startAngle + i * arc;
                        //ctx.fillStyle = colors[i];
                        ctx.fillStyle = getColor(i, options.length);

                        ctx.beginPath();
                        ctx.arc(
                            250,
                            250,
                            outsideRadius,
                            angle,
                            angle + arc,
                            false
                        );
                        ctx.arc(
                            250,
                            250,
                            insideRadius,
                            angle + arc,
                            angle,
                            true
                        );
                        ctx.stroke();
                        ctx.fill();

                        ctx.save();
                        ctx.shadowOffsetX = -1;
                        ctx.shadowOffsetY = -1;
                        ctx.shadowBlur = 0;
                        ctx.shadowColor = "rgb(220,220,220)";
                        ctx.fillStyle = "black";
                        ctx.translate(
                            250 + Math.cos(angle + arc / 2) * textRadius,
                            250 + Math.sin(angle + arc / 2) * textRadius
                        );
                        ctx.rotate(angle + arc / 2 + Math.PI / 2);
                        var text = options[i];
                        ctx.fillText(
                            text,
                            -ctx.measureText(text).width / 2,
                            0
                        );
                        ctx.restore();
                    }

                    //Arrow
                    ctx.fillStyle = "black";
                    ctx.beginPath();
                    ctx.moveTo(250 - 4, 250 - (outsideRadius + 5));
                    ctx.lineTo(250 + 4, 250 - (outsideRadius + 5));
                    ctx.lineTo(250 + 4, 250 - (outsideRadius - 5));
                    ctx.lineTo(250 + 9, 250 - (outsideRadius - 5));
                    ctx.lineTo(250 + 0, 250 - (outsideRadius - 13));
                    ctx.lineTo(250 - 9, 250 - (outsideRadius - 5));
                    ctx.lineTo(250 - 4, 250 - (outsideRadius - 5));
                    ctx.lineTo(250 - 4, 250 - (outsideRadius + 5));
                    ctx.fill();
                }
            }

            function spin() {
                spinAngleStart = Math.random() * 10 + 10;
                spinTime = 0;
                spinTimeTotal = Math.random() * 3 + 4 * 1000;
                rotateWheel();
            }

            function rotateWheel() {
                spinTime += 30;
                if (spinTime >= spinTimeTotal) {
                    stopRotateWheel();
                    return;
                }
                var spinAngle =
                    spinAngleStart -
                    easeOut(spinTime, 0, spinAngleStart, spinTimeTotal);
                startAngle += (spinAngle * Math.PI) / 180;
                drawRouletteWheel();
                spinTimeout = setTimeout("rotateWheel()", 30);
            }

            function stopRotateWheel() {
                clearTimeout(spinTimeout);
                var degrees = (startAngle * 180) / Math.PI + 90;
                var arcd = (arc * 180) / Math.PI;
                var index = Math.floor((360 - (degrees % 360)) / arcd);
                ctx.save();
                ctx.font = "bold 30px Helvetica, Arial";
                var text = options[index];
                ctx.fillText(
                    text,
                    250 - ctx.measureText(text).width / 2,
                    250 + 10
                );
                ctx.restore();
            }

            function easeOut(t, b, c, d) {
                var ts = (t /= d) * t;
                var tc = ts * t;
                return b + c * (tc + -3 * ts + 3 * t);
            }

            drawRouletteWheel();
            //  Cannot read properties of null;
            const restaurantList =
                JSON.parse(localStorage.getItem("restaurantList")) || [];
            restaurantList.forEach(function (restaurant) {
                document.getElementById("restaurant-list").innerHTML += `
                <li class="list-grop-item">
                    ${restaurant.name}
                <button class="btn-close float-end remove"></button>
                    </li>
                `;
            });
        </script>

        <script
            async
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD9SLxI5tVgcUxczQo-cNXn1-vFtSX9Ke8&libraries=places&callback=initMap&region=TW&language=zh-TW"
        ></script>
    </body>
</html>
